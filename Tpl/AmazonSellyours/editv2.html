<layout name='Layout/ace_popup' />
	<form action="{:U('save')}" method="POST" name="editForm" id="editForm" class="well form-horizontal clearfix">
		<input type="hidden" name="id" value="{$vo.id}">
		<input type="hidden" id="opmode" name="opmode" value="{$vo.opmode}" >
		<input type="hidden" id="sales_rank" name="sales_rank" value="{$vo.sales_rank}" >
		<input type="hidden" id="sales_rank_category" name="sales_rank_category" value="{$vo.sales_rank_category}" >
		<input type="hidden" id="price_currency" name="price_currency" value="{$vo.price_currency}" >
		<input type="hidden" id="website" name="website" value="{$vo.website}" >
		<input type="hidden" id="website_id" name="website_id" value="{$vo.website_id}" >
		<input type="hidden" id="parent_asin" name="parent_asin" value="{$vo.parent_asin}" >
		<input type="hidden" id="marketplace_id" name="marketplace_id" value="{$vo.marketplace_id}" >
		<input type="hidden" id="last_update" name="last_update" value="<?php echo time(); ?>" >
		<input type="hidden" id="add_review_id" name="add_review_id" value="{$Think.request.add_review_id}" >
		<div class="form-group">
			<div class='col-xs-12'>
				<label class="control-label" for="asin">ASIN</label>
				<!-- <a href="http://www.amazon.com/dp/{$vo.asin}" target="_blank" id="product_link" class="btn btn-xs btn-danger">Product</a>
				<a href="http://www.amazon.com/gp/offer-listing/{$vo.asin}?condition=new" id="offers_link" target="_blank" class="btn btn-xs btn-danger">Offers</a> -->
			</div>
			<div class="col-xs-6">
				<input class="form-control " type="text" id="asin" name="asin" value="{$vo.asin}" <?php if($vo['asin']) echo "disabled"; ?>>
			</div>
			<div class="col-xs-4">
				<select class="form-control" id="account_id" name="account_id">
					<option value="">通用</option>
					<volist name="accountList" id="account">
						<option value="{$account.id}" <?php if($_SESSION['AmazonSellyours']['account_id'] == $account['id']){ echo "selected"; } ?>>{$account.website_name}=>{$account.proxy_host}=>{$account.account_name}</option>
					</volist>
				</select>
			</div>
			<div class="col-xs-2">
				<a id="retryASIN" class="btn btn-xs btn-success">重试</a> 
				<a id="resetASIN" class="btn btn-xs btn-warning">清空</a>
			</div>			
		</div>
		<div class="form-group">
			<div class="col-xs-8">
				<label class="control-label" for="product_name">产品名称</label>
				<input class="form-control" type="text" id="product_name" name="product_name" value="{$vo.product_name}">
			</div>
			<div class="col-xs-4">
				<label class="control-label" for="is_owner">拥有修改</label>
				<select class="form-control" id="is_owner" name="is_owner" class="is_owner" >
					<option value="Owner" <eq name="vo.is_owner" value="Owner" >selected</eq> >Owner</option>
					<option value="Others" <eq name="vo.is_owner" value="Others" >selected</eq> >Others</option>
				</select>
			</div>
		</div>
		<div class="form-group">
			<div class="col-xs-8">
				<label class="control-label" for="thumbnail">图片网址</label>
				<input class="form-control thumbnail_clipboard" type="text" id="thumbnail" name="thumbnail" value="{$vo.thumbnail}">	
			</div>
			<div class="col-xs-4">
				<a href="{$vo.thumbnail}" target="_blank" id="a_thumbnail" class="thumbnail"><img src="{$vo.thumbnail}" id="img_thumbnail" width="60" /></a>
			</div>
			
		</div>		
		
			
		<table class="table col-xs-12">
			<tr>
				<td>长</td>
				<td>宽</td>
				<td>高</td>
				<td>单位</td>
			</tr>
			<tr>
				<td>
					<input class="form-control" type="text" id="package_length" name="package_length" value="{$vo.package_length}">
				</td>
				<td>
					<input class="form-control" type="text" id="package_width" name="package_width" value="{$vo.package_width}">
				</td>
				<td>
					<input class="form-control" type="text" id="package_height" name="package_height" value="{$vo.package_height}">
				</td>
				<td>
					<input class="form-control" type="text" id="package_dimension_unit" name="package_dimension_unit" value="{$vo.package_dimension_unit}">
				</td>
			</tr>				
		</table>
		
		<table class="table col-xs-12">
			<tr>
				<td>产品重量</td>
				<td>重量单位</td>
				<td>真实重量(g)</td>
				<td>真实抛重(g)</td>
				<td>申报名称</td>
				<td>申报名称中文</td>
			</tr>
			<tr>
				<td>
					<input class="form-control" type="text" id="package_weight" name="package_weight" value="{$vo.package_weight}">
				</td>
				<td>
					<input class="form-control" type="text" id="package_weight_unit" name="package_weight_unit" value="{$vo.package_weight_unit}">
				</td>
				<td>
					<input class="form-control" type="text" id="real_package_weight" name="real_package_weight" value="{$vo.real_package_weight}">
				</td>
				<td>
					<input class="form-control" type="text" id="real_volume_weight" name="real_volume_weight" value="{$vo.real_volume_weight}">
				</td>
				<td>
					<input class="form-control" type="text" id="declare_name" name="declare_name" value="{$vo.declare_name}">
				</td>
				<td>
					<input class="form-control" type="text" id="declare_name_cn" name="declare_name_cn" value="{$vo.declare_name_cn}">
				</td>
			</tr>				
		</table>
		
		<div class="form-group">
			<label class="control-label" for="source_link">货源链接</label> <a href="{$vo.source_link}" target="_blank" id="source_link_a" class="btn btn-xs btn-danger">链接</a>
			<input class="form-control" type="text" id="source_link" name="source_link" value="{$vo.source_link}">
		</div>
		
			<table class="table">
				<tr>
					<td class="col-xs-3">货源价格（RMB）</td>
					<td>货源规格</td>
				</tr>
				<tr>
					<td>
						<input class="form-control" type="text" id="source_price" name="source_price" value="{$vo.source_price}">
					</td>
					<td>
						<input class="form-control" type="text" id="source_variation" name="source_variation" value="{$vo.source_variation}">
					</td>
				</tr>
			</table>
		
		<div class="form-group">
			<label class="control-label" for="purchase_memo">采购备注</label> 
			<textarea name="purchase_memo" id="purchase_memo" class="form-control" rows="1">{$vo.purchase_memo}</textarea>
		</div>			
		<div class="form-group">
			<div class="col-xs-6">
				<label class="control-label red" for="trademark">商标</label>
				<input class="form-control" type="text" id="trademark" name="trademark" value="{$vo.trademark}">
			</div>
			<div class="col-xs-6">
				<label class="control-label red" for="product_rank">评分</label>
				<select name="product_rank" id="product_rank" class="form-control">
					<option value="0">请选择评分</option>
				<?php for($i=10; $i > 0 ; $i--){  ?>
					<option value="{$i}" <?php if($i == $vo['product_rank']){ echo "selected"; } ?> >{$i}</option>
				<?php } ?>
				</select>
			</div>
		</div>				
		<!--
		<div class="form-group">
			<div class='col-xs-12'>
				<label class="control-label" for="sales_rank">商品排名</label>
			</div>
			<div class="col-xs-6">
				<span id="sales_rank_html">{$vo.sales_rank}</span> in <span id="sales_rank_category_html">{$vo.sales_rank_category}</span>
			</div>
			<div class="col-xs-6">
				<a id="retryCompetitive" class="btn btn-xs btn-success col-xs-2 ">刷新</a>
			</div>
		</div>		
		<table class="table col-xs-12">
			<tr>
				<td>卖家人数</td>
				<td>FBA人数</td>
				<td>卖家最低价</td>
				<td>FBA最低价</td>
				<td>建议价 <span id="price_currency_html">{$vo.price_currency}</span></td>
			</tr>
			<tr>
				<td>
					<input type="text" name="offer_count" id="offer_count" class="form-control" value="{$vo.offer_count}" />
				</td>
				<td>
					<input type="text" name="FBA_count" id="FBA_count" class="form-control" value="{$vo.FBA_count}" />
				</td>
				<td>
					<input type="text" name="offer_lowest" id="offer_lowest" class="form-control" value="{$vo.offer_lowest}" />
				</td>
				<td>
					<input type="text" name="FBA_lowest" id="FBA_lowest" class="form-control" value="{$vo.FBA_lowest}" />
				</td>	
				<td>
					<input type="text" name="competitive_price" id="competitive_price" class="form-control" value="{$vo.competitive_price}" /> 
				</td>					
			</tr>				
		</table> -->

<!-- 		<div class="form-group">
			<label class="control-label" for="customer_reviews">Reviews数</label>
			<input class="form-control" type="text" id="customer_reviews" name="customer_reviews" value="{$vo.customer_reviews}">
		</div> -->

		<div class="form-group">
			<label class="control-label" for="memo">备注</label>
			<textarea name="memo" id="memo" class="form-control">{$vo.memo}</textarea>
		</div>		
		<div class="form-group text-center">
			<input type="submit" id="editFormSubmit" data-loading-text="正在保存..."  class="btn btn-primary" value="保存" />
			<a class="btn btn-success" id="cancel">取消</a>
		</div>
	</form>
<script type="text/javascript">
var isRetry = false;
$(function(){
	maxHeight = parent.document.documentElement.clientHeight ;
	height = document.body.clientHeight+ 50;
	if(height > maxHeight){
		height = maxHeight;
	}
	parent.$("#middleBoxIframe").css("height",height);

	$("#asin").change(function(){

		if($(this).val() == ''){
			return ;
		}
		$("#asin").attr("disabled","disabled");
		$("#retryASIN").attr("disabled","disabled");
		$("#retryCompetitive").attr("disabled","disabled");
		var obj  = $(this);
		var asin = $(this).val();
		var data = {asin:asin,isRetry:isRetry,account_id:$("#account_id").val()};
		$.ajax({
			url:"{:U('getAsinDetail')}",
			type:"POST",
			data:data,
			success:function(r){
				if(r.status){
					$("#package_weight").val(r.data.weight);
					$("#package_height").val(r.data.height);
					$("#package_length").val(r.data.length);
					$("#package_width").val(r.data.width);
					$("#package_weight_unit").val(r.data.weight_unit);
					$("#package_dimension_unit").val(r.data.dimension_unit);
					$("#thumbnail").val(r.data.thumbnail);
					$("#img_thumbnail").attr('src',r.data.thumbnail);
					$("#product_name").val(r.data.title);
					$("#trademark").val(r.data.brand);
					$("#price_currency").val(r.data.price_currency);
					$("#website").val(r.data.website);
					$("#website_id").val(r.data.website_id);
					$("#parent_asin").val(r.data.parent_asin);
					$("#marketplace_id").val(r.data.marketplace_id);
					$("#price_currency_html").html(r.data.price_currency);
					$("#sales_rank").val(r.data.sales_rank);
					$("#sales_rank_category").val(r.data.sales_rank_category);
				}else{
					alert(r.info);
				}
				$("#asin").attr("disabled",null);
				$("#retryASIN").attr("disabled",null);
				$("#retryCompetitive").attr("disabled",null);
			},
			error:function(){
				//失败，重新触发该事件。
				$("#asin").change();
			}
		})

		//getCompetitiveDetail();
	})

	

	$("#retryASIN").click(function(){
		isRetry = true;
		$("#asin").change();
	})

	$("#retryCompetitive").click(function(){
		getCompetitiveDetail();
	})

	$("body").click(function(){
		isRetry = false;
	})

	$("#resetASIN").click(function(){
		$("#asin").val('');
	})

	$("#code").change(function(){

		var code = $(this).val(),
			data = {code:code};
		$.post("{:U('parseCode')}",data,function(r){
			if(r.status){
				$("#asin").val(r.data.asin);
				$("#customer_reviews").val(r.data.customer_reviews);
				$("#price_lowest").val(r.data.price_lowest);
				$("#product_name").val(r.data.product_name);
				$("#editForm_thumbnail").val(r.data.thumbnail);
				$("#img_thumbnail").attr("src",r.data.thumbnail);
				$("#a_thumbnail").attr("href",r.data.thumbnail);
				
				$("#trademark").val(r.data.trademark);
	
			}else{
				alertWarning(r.info);
			}
		})
	})

	$("#cancel").click(function(){
		parent.$("#middleBox").modal("hide");
	})
	$("#delete").click(function(){
		if(window.confirm("Delete? ")){
			$("#opmode").val("del");
			var data = $("#editForm").serialize();
			var url = $("#editForm").attr("action");
			$.post(url,data,function(r){
				if(r.status){

					parent.$("#form_search").submit();

					//parent.window.location.reload();

				}else{
					alertWarning(r.info);
					return false;
				}
			})
		}else{
			return false;
		}

		return false;
	})

	$("#editFormSubmit").click(function(){
		$("#editFormSubmit").attr("disabled","disabled");
		var data = $("#editForm").serialize();
		var url = $("#editForm").attr("action");
		$.post(url,data,function(r){
			$("#editFormSubmit").attr("disabled",null);
			if(r.status){

				//parent.$("#middleBox").modal("hide");
				parent.$("#form_search").submit();
				//parent.window.location.reload();

			}else{
				alertWarning(r.info);
				return false;
			}
		})
		return false;
	})
})


function getCompetitiveDetail(){
	return false;
	var asin = $("#asin").val();
	if(asin == ''){
		alert("Missing ASIN");
		return false;
	}
	var data = {
		asin:asin,
		account_id:$("#account_id").val()
	};
	$("#asin").attr("disabled","disabled");
	$("#retryASIN").attr("disabled","disabled");
	$("#retryCompetitive").attr("disabled","disabled");
	$.ajax({
		url:"{:U('getCompetitiveDetail')}",
		type:"POST",
		data:data,
		success:function(r){
			if(r.status){
				$("#offer_count").val(r.data.offer_count);
				$("#offer_lowest").val(r.data.offer_lowest);
				$("#FBA_lowest").val(r.data.FBA_lowest);
				$("#competitive_price").val(r.data.competitive_price);
				$("#sales_rank").val(r.data.sales_rank);
				$("#sales_rank_html").html(r.data.sales_rank);
				$("#sales_rank_category").val(r.data.sales_rank_category);		
				$("#sales_rank_category_html").html(r.data.sales_rank_category);	
						
			}else{
				alert(r.info);
			}
			$("#asin").attr("disabled",null);
			$("#retryASIN").attr("disabled",null);
			$("#retryCompetitive").attr("disabled",null);
		},
		error:function(){
			//失败，重新触发该事件。
			getCompetitiveDetail();
		}

	})
}

</script>
